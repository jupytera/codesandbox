  # CodeSandbox 数据库建表思路

## 整体架构设计

CodeSandbox 是一个企业级代码沙箱平台，需要支持代码片段的管理、版本控制、代码评审、代码执行和权限控制等功能。数据库设计遵循以下核心原则：

- **模块化**: 按功能模块划分表，清晰区分用户管理、权限控制、代码管理、评审系统、执行系统
- **规范化**: 避免数据冗余，采用适当的范式设计
- **可扩展性**: 预留扩展字段，支持未来功能增强
- **性能优化**: 合理设置索引，提高查询效率

---

## 核心模块设计

### 1. 用户管理模块 (Users)

#### 表: `users`
**设计目的**: 存储所有用户的基本信息和账户状态

**核心字段**:
- `id`: 自增主键
- `username / email`: 唯一标识用户的字段，便于登录和查找
- `password_hash`: 密码哈希值，确保安全性
- `email_verified / email_verification_token`: 支持邮箱验证流程
- `last_login`: 记录用户最后登录时间，用于活跃度分析
- `account_status`: ENUM 类型，支持账户状态流转 (ACTIVE/SUSPENDED/DELETED)
- `created_at / updated_at`: 时间戳，记录创建和更新时间

**索引策略**:
- `idx_username`: 加速用户名查询（登录场景）
- `idx_email`: 加速邮箱查询（邮箱验证、密码重置）
- `idx_account_status`: 加速按状态筛选用户

**特点**: 用户表是整个系统的核心，所有其他表都会引用此表

---

### 2. 权限控制模块 (RBAC - Role Based Access Control)

#### 表: `roles`
**设计目的**: 定义系统中的角色

**核心字段**:
- `id / role_name`: 角色的唯一标识
- `description`: 角色的用途说明
- `created_at`: 创建时间

**默认角色**:
```
1. ADMIN - 管理员，拥有所有权限
2. USER - 普通用户，基本权限
3. REVIEWER - 代码评审者
4. MODERATOR - 内容审核员
```

---

#### 表: `permissions`
**设计目的**: 定义系统中的所有权限

**核心字段**:
- `id / permission_name`: 权限的唯一标识
- `resource / action`: 资源-操作对，便于权限管理系统化
  - 例如: resource=`snippet`, action=`create` 表示"创建代码片段"权限
- `description`: 权限说明
- `created_at`: 创建时间

**权限分类**:
1. **用户管理权限** (user_view, user_create, user_update, user_delete)
2. **代码片段权限** (snippet_create, snippet_view, snippet_update, snippet_delete, snippet_share)
3. **代码评审权限** (review_create, review_approve, review_reject)
4. **代码执行权限** (execute_code, view_execution)
5. **管理员权限** (admin_panel, audit_logs, system_config)

**索引策略**:
- `idx_permission_name`: 加速权限查询
- `idx_resource_action`: 加速按资源和操作搜索权限

---

#### 表: `role_permissions`（关联表）
**设计目的**: 建立角色和权限的多对多关系

**设计特点**:
- 复合主键 (role_id, permission_id)，确保不重复分配
- 使用外键约束 ON DELETE CASCADE，删除角色时自动删除其权限关联

---

#### 表: `user_roles`（关联表）
**设计目的**: 建立用户和角色的多对多关系

**设计特点**:
- 复合主键 (user_id, role_id)
- 使用外键约束 ON DELETE CASCADE，用户删除时自动删除角色关联
- `assigned_at` 记录角色分配时间，便于权限审计

**权限查询流程**:
```
用户 -> 用户角色 -> 角色 -> 角色权限 -> 权限
```

---

### 3. 代码管理模块

#### 表: `code_snippets`
**设计目的**: 存储代码片段的基本信息

**核心字段**:
- `id`: 代码片段唯一标识
- `owner_id`: 所有者，外键引用 users 表
- `title / description`: 代码片段的元信息
- `language`: 编程语言，便于代码执行和高亮展示
- `visibility`: ENUM 类型，控制可见性
  - PRIVATE: 仅所有者可见
  - SHARED: 分享给特定用户
  - PUBLIC: 所有人可见
- `tags`: 标签，便于分类和搜索
- `view_count / fork_count`: 统计指标，用于排序和推荐
- `created_at / updated_at`: 时间戳

**索引策略**:
- `idx_owner_id`: 加速查询用户的所有代码片段
- `idx_language`: 加速按编程语言筛选
- `idx_visibility`: 加速权限检查
- `idx_created_at`: 加速时间范围查询
- `ft_title_description`: 全文索引，支持代码片段的标题和描述搜索

**特点**: 这是代码管理的核心表，关联版本、评审、分享等功能表

---

#### 表: `code_versions`
**设计目的**: 记录代码片段的版本历史，支持版本控制和回滚

**核心字段**:
- `id`: 版本记录的唯一标识
- `snippet_id`: 所属的代码片段，外键引用 code_snippets
- `version_number`: 版本号，与 snippet_id 组成唯一约束
- `content`: 完整的代码内容
- `delta_content`: 增量编码内容（存储与前一版本的差异）
  - 优化存储空间，可节省 90% 的存储空间
  - 回滚时通过反向应用 delta 恢复版本
- `author_id`: 版本作者，外键引用 users
- `commit_message`: 提交信息，类似 Git 的 commit message
- `created_at`: 版本创建时间

**索引策略**:
- `uq_snippet_version`: 唯一约束，确保每个代码片段的版本号唯一
- `idx_snippet_id`: 加速查询代码片段的所有版本
- `idx_author_id`: 加速查询用户创建的版本
- `idx_created_at`: 加速时间范围查询

**版本管理流程**:
```
用户编辑代码 -> 提交新版本 -> 生成 delta 增量 -> 存储版本记录
用户查看历史 -> 查询版本列表 -> 选择版本 -> 反向应用 delta 恢复代码
```

---

### 4. 代码评审模块

#### 表: `code_reviews`
**设计目的**: 记录代码评审任务

**核心字段**:
- `id`: 评审任务的唯一标识
- `snippet_id`: 被评审的代码片段，外键引用 code_snippets
- `reviewer_id`: 评审者，外键引用 users
- `status`: 评审状态
  - PENDING: 待评审
  - APPROVED: 已通过
  - CHANGES_REQUESTED: 请求修改
  - REJECTED: 已拒绝
- `review_content`: 整体评审意见
- `created_at / updated_at`: 时间戳

**索引策略**:
- `idx_snippet_id`: 加速查询代码片段的所有评审
- `idx_reviewer_id`: 加速查询评审者的评审任务
- `idx_status`: 加速按状态筛选（如查询所有待评审的任务）

---

#### 表: `review_comments`
**设计目的**: 记录评审过程中的逐行评论

**核心字段**:
- `id`: 评论的唯一标识
- `review_id`: 所属的评审任务，外键引用 code_reviews
- `author_id`: 评论作者，外键引用 users
- `content`: 评论内容
- `line_number`: 代码行号，便于关联具体的代码位置
- `created_at / updated_at`: 时间戳

**设计特点**:
- 支持逐行评论，类似 GitHub 的 Pull Request 评审
- 与版本无关，支持多轮评审

---

### 5. 代码分享模块

#### 表: `code_shares`
**设计目的**: 管理代码片段的分享信息

**核心字段**:
- `id`: 分享记录的唯一标识
- `snippet_id`: 被分享的代码片段，外键引用 code_snippets
- `shared_by`: 分享者，外键引用 users
- `shared_with`: 分享给的用户，外键引用 users（可为 null 表示公开分享）
- `share_token`: 分享令牌，生成唯一的分享链接
- `expiration_date`: 分享过期时间（可选）
- `created_at`: 分享创建时间

**索引策略**:
- `idx_snippet_id`: 加速查询代码片段的所有分享
- `idx_share_token`: 加速分享链接验证（UNIQUE 索引）
- `idx_shared_with`: 加速查询用户收到的分享

**分享流程**:
```
生成分享令牌 -> 生成分享链接 -> 用户访问链接 -> 验证令牌 -> 显示代码
```

---

### 6. 代码执行模块

#### 表: `execution_tasks`
**设计目的**: 记录代码执行的任务和结果

**核心字段**:
- `id`: 执行任务的唯一标识
- `snippet_id`: 执行的代码片段，外键引用 code_snippets（可为 null，支持独立执行）
- `executor_id`: 执行者，外键引用 users
- `language`: 编程语言
- `code_content`: 执行的代码内容
- `input_data`: 输入数据（stdin）
- `output_data`: 输出结果（stdout）
- `error_message`: 错误信息（stderr）
- `status`: 执行状态
  - PENDING: 待执行
  - RUNNING: 执行中
  - COMPLETED: 已完成
  - FAILED: 执行失败
  - TIMEOUT: 超时
- `execution_time_ms`: 执行耗时（毫秒），用于性能分析
- `memory_used_mb`: 内存使用量（MB），用于资源监控
- `container_id`: Docker 容器 ID，支持沙箱隔离追踪
- `created_at / completed_at`: 时间戳

**索引策略**:
- `idx_snippet_id`: 加速查询代码片段的执行历史
- `idx_executor_id`: 加速查询用户的执行记录
- `idx_status`: 加速按状态筛选（如查询所有运行中的任务）
- `idx_created_at`: 加速时间范围查询

**执行流程**:
```
用户提交代码 -> 创建 PENDING 任务 -> Docker 沙箱执行 -> 更新为 RUNNING
-> 执行完成 -> 保存结果 -> 更新为 COMPLETED/FAILED/TIMEOUT
```

---

### 7. 审计日志模块

#### 表: `audit_logs`
**设计目的**: 记录系统中所有重要操作，用于安全审计和合规

**核心字段**:
- `id`: 日志记录的唯一标识
- `user_id`: 操作者，外键引用 users（可为 null 表示系统操作）
- `action`: 操作类型（CREATE, UPDATE, DELETE, SHARE, EXECUTE 等）
- `resource_type`: 资源类型（USER, SNIPPET, REVIEW 等）
- `resource_id`: 资源 ID
- `old_value / new_value`: 变更前后的值（JSON 格式），支持数据恢复
- `ip_address`: 操作者的 IP 地址
- `user_agent`: 用户代理，便于分析客户端信息
- `created_at`: 操作时间

**索引策略**:
- `idx_user_id`: 加速查询用户的操作历史
- `idx_action`: 加速按操作类型筛选
- `idx_resource_type`: 加速按资源类型筛选
- `idx_created_at`: 加速时间范围查询

**审计场景**:
```
代码删除 -> 记录 DELETE 操作 + 旧值 -> 支持恢复
用户权限变更 -> 记录 UPDATE 操作 + 旧新值 -> 合规性检查
```

---

### 8. 登录历史模块

#### 表: `login_history`
**设计目的**: 记录用户的登录活动，用于安全分析和异常检测

**核心字段**:
- `id`: 登录记录的唯一标识
- `user_id`: 用户，外键引用 users
- `login_time`: 登录时间
- `ip_address`: 登录 IP 地址
- `user_agent`: 浏览器信息
- `login_success`: 登录是否成功
- `failure_reason`: 登录失败原因（如"密码错误"、"账户已禁用"等）

**索引策略**:
- `idx_user_id`: 加速查询用户的登录历史
- `idx_login_time`: 加速时间范围查询（如查询最近 30 天的登录）
- `idx_ip_address`: 加速按 IP 地址查询（异常检测）

**安全应用**:
```
用户登录 -> 记录登录信息 -> 异常检测（陌生 IP、失败尝试过多）
```

---

### 9. 令牌黑名单模块

#### 表: `token_blacklist`
**设计目的**: 存储被撤销的 JWT 令牌，防止已注销的用户继续使用令牌

**核心字段**:
- `id`: 黑名单记录的唯一标识
- `token`: JWT 令牌（UNIQUE 索引）
- `user_id`: 用户，外键引用 users
- `revoked_at`: 撤销时间
- `expiration_time`: 令牌原本的过期时间（可以在该时间后删除记录）
- `reason`: 撤销原因（如"用户登出"、"密码修改"、"会话过期"等）

**索引策略**:
- `idx_user_id`: 加速查询用户的黑名单令牌
- `idx_expiration_time`: 加速定期清理过期的黑名单记录

**令牌验证流程**:
```
用户请求 -> 检查 JWT 令牌 -> 查询黑名单 -> 有效则继续，无效则拒绝
```

---

## 表间关系映射

```
users (一) ─── (多) user_roles ─── (多) roles ─── (多) role_permissions ─── (多) permissions
     │
     ├─(一) ─── (多) code_snippets
     │              │
     │              ├─(一) ─── (多) code_versions
     │              │
     │              ├─(一) ─── (多) code_reviews ─── (一) ─── (多) review_comments
     │              │
     │              ├─(一) ─── (多) code_shares
     │              │
     │              └─(一) ─── (多) execution_tasks
     │
     ├─(一) ─── (多) login_history
     │
     ├─(一) ─── (多) token_blacklist
     │
     └─(一) ─── (多) audit_logs (作为操作者)
```

---

## 性能优化策略

### 索引设计
- **单列索引**: 用于频繁的 WHERE、ORDER BY、JOIN 条件
- **复合索引**: 对于多条件查询
- **唯一索引**: 确保数据唯一性（如 share_token）
- **全文索引**: 支持代码片段的标题和描述搜索

### 存储优化
- **LONGTEXT**: 存储大量代码内容
- **Delta 编码**: 代码版本使用增量存储，节省 90% 空间
- **自动清理**: 定期删除过期的黑名单令牌

### 查询优化
- **分页**: 大量数据使用分页查询
- **缓存**: 热门代码片段缓存到 Redis
- **异步**: 审计日志、执行结果等可异步写入

---

## 扩展方向

### 未来可能添加的表
1. **消息表** - 用户间消息通知
2. **标签表** - 标签分类和管理
3. **收藏表** - 用户收藏代码片段
4. **代码克隆表** - 追踪代码克隆关系
5. **执行环境表** - 支持多种执行环境配置

### 数据分析
- 使用 Elasticsearch 存储代码片段的可搜索数据
- 使用 Redis 缓存热门代码和用户会话
- 定期导出审计日志进行合规分析

---

## 总结

这个数据库设计采用了**模块化、规范化、可扩展**的方法，清晰划分了九个核心模块：
1. 用户管理
2. 权限控制（RBAC）
3. 代码管理
4. 代码评审
5. 代码分享
6. 代码执行
7. 审计日志
8. 登录历史
9. 令牌黑名单

每个模块都有明确的职责和优化策略，支持企业级代码沙箱平台的功能需求。
